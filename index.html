<!DOCTYPE html>
<html>
<head>
<title>檢驗報告彙總</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>
<style>
html {font-size: 18px;}
.container { display: flex; width: 1920px;  }
.theerror {font-size: 40px; font-family: '微軟正黑體', sans-serif; line-height: 1.2;}
.thesitename {width: 1100px; text-align: center; font-size: 40px; font-family: '微軟正黑體', sans-serif; line-height: 1.2;}
.basic {font-size: 24px; font-family: '微軟正黑體', sans-serif; line-height: 1.2;}
.thetable { flex: 0 0 1050px; border-collapse: collapse; height: 0px; }
.thetable th { border: 2px solid #020202; text-align: center; padding: 8px; font-size: 20px; font-family: '微軟正黑體'}
.thetable td { border: 2px solid #020202; text-align: center; padding: 8px; font-size: 20px; font-family: '微軟正黑體'}
.thetable tr { border: 2px solid #020202; text-align: center; padding: 8px; font-size: 20px; font-family: '微軟正黑體'}
.thetable th { background-color: #f2f2f2;}
.outer_button { font-size: 18px; font-family: '微軟正黑體', sans-serif;}
.inner_button {  font-size: 16px; font-family: '微軟正黑體', sans-serif;}
select {  font-size: 18px; font-family: '微軟正黑體', sans-serif;}
input {  font-size: 18px; font-family: '微軟正黑體', sans-serif;}
#chartContainer { width: 600px; height: 600px;}
#myLineChart { width: 600px; height: 600px;}
@media print {.no-print {display: none !important;}}
.overlay {position: fixed; top: 0;left: 0;width: 100%;height: 100%;background: rgba(0, 0, 0, 0.5); z-index: 9999; }
</style>
</head>
<body>
<div class="thesitename" id="thesitename">檢驗報告彙總</div>
<div>
<span class='no-print'>衛生所:</span>
<select class='no-print' id="thesite" name="thesite" type="text" style="width:150px">
	<option value="X001">社頭鄉</option>
	<option value="X002">秀水鄉</option>
	<option value="X003">溪湖鎮</option>
	<option value="X004">鹿港鎮</option>
	<option value="X007">永靖鄉</option>
	<option value="X008">埔心鄉</option> 
	<option value="X009">福興鄉</option>
	<option value="X010">埔鹽鄉</option>
	<option value="X011">二水鄉</option>
	<option value="X012">田中鎮</option>
	<option value="X013">北斗鎮</option>
	<option value="X014">員林市</option>
	<option value="X015">和美鎮</option>
	<option value="X016">線西鄉</option>
	<option value="X017">花壇鄉</option>
	<option value="X018">芬園鄉</option>
	<option value="X019">伸港鄉</option>
	<option value="X020">大村鄉</option> 
	<option value="X021">二林鎮</option>
	<option value="X022">田尾鄉</option>
	<option value="X023">埤頭鄉</option> 
	<option value="X024">芳苑鄉</option>
	<option value="X025">大城鄉</option>
	<option value="X026">竹塘鄉</option>
	<option value="X027">溪州鄉</option>
	<option value="X028">東區</option>
	<option value="X029">南西北</option>
</select>
<span class='no-print'>身份證字號:</span>
<input class='no-print' type="theid" id="theid" style="width: 150px;"></input>
<button class='outer_button no-print' onclick="searchdata()">查詢</button>
</div>
<div class="basic"></div>
<span class="basic" id="basicname" style="display: inline-block; width: 300px;"></span>
<span class="basic" id="basicid" style="display: inline-block; width: 300px;"></span>
<span class="basic" id="basicbirth" style="display: inline-block; width: 300px;"></span>
<div class="container" id="chartContainer">
</div>
<script>function searchdata(){var e=document.getElementById("thesite").value,t=document.getElementById("theid").value;if(""!=e&&null!=e&&""!=t&&null!=t)if(theapiurl="https://script.google.com/macros/s/AKfycbxvAz2qT95uxLe-yqoO9WnYdQLZTUZzBBZwsOrhAhWnIjMX_1ugRuVZ5tCcg6JzFCd5hA/exec",Url=theapiurl+"?mode=download&thesite="+e+"&theid="+t,xmlHttp=new XMLHttpRequest,xmlHttp.open("GET",Url,!1),xmlHttp.send(),res=xmlHttp.responseText,"error"!=res){currentsort="D",jres=JSON.parse(res),document.querySelector("title").textContent="檢驗報告彙總("+jres[0].NAME+")",document.getElementById("thesitename").textContent=jres[0].HOS_NAME+"檢驗報告彙總",document.getElementById("basicname").textContent="姓名:"+jres[0].NAME,document.getElementById("basicid").textContent="證號:"+jres[0].ID,cyb=jres[0].BIRTH.split("T")[0],mkyyb=cyb.split("-")[0]-1911,mkyb=mkyyb+cyb.split("-")[1]+cyb.split("-")[2],document.getElementById("basicbirth").textContent="生日:"+mkyb,container=document.getElementById("chartContainer"),container.innerHTML="";var l=document.createElement("table");for(l.className="thetable",titilelist=["日期▼","AC","A1C","TC","TG","HDL","LDL","Cre","eGFR","UPCR","UACR","GOT","GPT","UA","",""],inserttitle(l,titilelist),insertdata={},i=0;i<jres.length;i++){for(CYdate=jres[i].OP_DATE1.split("T")[0],MKYY=CYdate.split("-")[0]-1911,MKY=MKYY+CYdate.split("-")[1]+CYdate.split("-")[2],null==insertdata[MKY]&&(insertdata[MKY]={}),null==insertdata[MKY].rowdata&&(insertdata[MKY].rowdata=[]),insertdata[MKY].rowdata.push(jres[i]),j=0;j<jres[i].modelOP013M1s.length;j++)"09005C"==jres[i].modelOP013M1s[j].LABNUM&&(insertdata[MKY].AC=jres[i].modelOP013M1s[j].S_INPUT1),"09006C"==jres[i].modelOP013M1s[j].LABNUM&&(insertdata[MKY].A1C=jres[i].modelOP013M1s[j].S_INPUT1),"09006C"==jres[i].modelOP013M1s[j].LABNUM&&(insertdata[MKY].A1C=jres[i].modelOP013M1s[j].S_INPUT1),"09001C"==jres[i].modelOP013M1s[j].LABNUM&&(insertdata[MKY].TC=jres[i].modelOP013M1s[j].S_INPUT1),"09004C"==jres[i].modelOP013M1s[j].LABNUM&&(insertdata[MKY].TG=jres[i].modelOP013M1s[j].S_INPUT1),"09043C"==jres[i].modelOP013M1s[j].LABNUM&&(insertdata[MKY].HDL=jres[i].modelOP013M1s[j].S_INPUT1),"09044C"==jres[i].modelOP013M1s[j].LABNUM&&(insertdata[MKY].LDL=jres[i].modelOP013M1s[j].S_INPUT1),"LDL(C)"==jres[i].modelOP013M1s[j].desc1&&null==insertdata[MKY].LDL&&(insertdata[MKY].LDL=jres[i].modelOP013M1s[j].S_INPUT1),"09015C"==jres[i].modelOP013M1s[j].LABNUM&&(insertdata[MKY].Cre=jres[i].modelOP013M1s[j].S_INPUT1),"Y00001"==jres[i].modelOP013M1s[j].LABNUM&&(insertdata[MKY].eGFR=jres[i].modelOP013M1s[j].S_INPUT1),"Y00002"==jres[i].modelOP013M1s[j].LABNUM&&("UPCR"==jres[i].modelOP013M1s[j].LAB1&&(insertdata[MKY].PCR=jres[i].modelOP013M1s[j].S_INPUT1),"ACR"==jres[i].modelOP013M1s[j].LAB1&&(insertdata[MKY].ACR=jres[i].modelOP013M1s[j].S_INPUT1)),"09040C"==jres[i].modelOP013M1s[j].LABNUM&&(insertdata[MKY].UP=jres[i].modelOP013M1s[j].S_INPUT1),"12111C"==jres[i].modelOP013M1s[j].LABNUM&&(insertdata[MKY].MA=jres[i].modelOP013M1s[j].S_INPUT1),"09016C"==jres[i].modelOP013M1s[j].LABNUM&&(insertdata[MKY].Ucre=jres[i].modelOP013M1s[j].S_INPUT1),"09025C"==jres[i].modelOP013M1s[j].LABNUM&&(insertdata[MKY].GOT=jres[i].modelOP013M1s[j].S_INPUT1),"09026C"==jres[i].modelOP013M1s[j].LABNUM&&(insertdata[MKY].GPT=jres[i].modelOP013M1s[j].S_INPUT1),"09013C"==jres[i].modelOP013M1s[j].LABNUM&&(insertdata[MKY].UA=jres[i].modelOP013M1s[j].S_INPUT1);null==insertdata[MKY].PCR&&null!=insertdata[MKY].UP&&null!=insertdata[MKY].Ucre&&(PCR=insertdata[MKY].UP/insertdata[MKY].Ucre*1e3,insertdata[MKY].PCR=PCR),null==insertdata[MKY].ACR&&null!=insertdata[MKY].MA&&null!=insertdata[MKY].Ucre&&(ACR=insertdata[MKY].MA/insertdata[MKY].Ucre*1e3,insertdata[MKY].ACR=ACR)}thedates=Object.keys(insertdata),thedates.sort(function(e,t){return t.localeCompare(e)}),insert(l,thedates),chartContainer=document.createElement("div"),chartContainer.id="chartContainer",myLineChart=document.createElement("canvas"),myLineChart.id="myLineChart",myLineChart.className="no-print",container.appendChild(l),chartContainer.appendChild(myLineChart),container.appendChild(chartContainer)}else document.getElementById("basicname").textContent="查無個案",document.getElementById("basicid").textContent="",document.getElementById("basicbirth").textContent="";else alert("請輸入ID")}function inserttitle(e,t){for(row=e.insertRow(),i=0;i<t.length;i++)cellt=row.insertCell(i),cellt.style.height="23px",0==i?cellt.addEventListener("dblclick",function(e){sortdate()}):i>0&&i<14?cellt.addEventListener("dblclick",function(t){if("TD"===t.target.tagName){var l=t.target.cellIndex;for(title=e.rows[0].cells[l].textContent,tempdata={},j=1;j<e.rows.length;j++)""!=e.rows[j].cells[l].textContent&&(tempdata[e.rows[j].cells[0].textContent]=e.rows[j].cells[l].textContent);for(tempdate=Object.keys(tempdata),tempdate.sort(function(e,t){return e.localeCompare(t)}),jsonData=[],j=0;j<tempdate.length;j++)jcy=tempdate[j],jcyy=1*jcy.substring(0,3)+1911,jcym=jcy.substring(3,5),jcyd=jcy.substring(5,7),jmky=jcyy+"-"+jcym+"-"+jcyd,tempxy={},tempxy.x=jmky,tempxy.y=parseFloat(tempdata[tempdate[j]]),jsonData.push(tempxy);standardvelue={AC:[70,100],A1C:[5.6,6.5],TC:[null,200],TG:[null,150],HDL:[40,null],LDL:[null,130],Cre:[null,1.3],eGFR:[null,60],UPCR:[null,150],UACR:[null,30],GOT:[null,40],GPT:[null,40],UA:[null,7]},drowlinechart(title,jsonData,standardvelue[title][0],standardvelue[title][1])}}):cellt.className="no-print",cellt.textContent=t[i]}function insert(e,t){for(i=0;i<thedates.length;i++)FMKY=thedates[i],TR=insertdata[FMKY],Object.keys(TR).length>0&&(row=e.insertRow(),row.style.height="23px",cell=row.insertCell(),cell.style.height="23px",cell.addEventListener("dblclick",function(e){copyrow(e.target.parentNode)}),cell.textContent=FMKY,cell=row.insertCell(),cell.style.height="23px",cell.textContent=TR.AC,cell=row.insertCell(),cell.style.height="23px",cell.textContent=TR.A1C,cell=row.insertCell(),cell.style.height="23px",cell.textContent=TR.TC,cell=row.insertCell(),cell.style.height="23px",cell.textContent=TR.TG,cell=row.insertCell(),cell.style.height="23px",cell.textContent=TR.HDL,cell=row.insertCell(),cell.style.height="23px",cell.textContent=TR.LDL,cell=row.insertCell(),cell.style.height="23px",cell.textContent=TR.Cre,cell=row.insertCell(),cell.style.height="23px",cell.textContent=TR.eGFR,cell=row.insertCell(),cell.style.height="23px",null!=TR.PCR&&(PCR=1*TR.PCR,cell.textContent=PCR.toFixed(1)),cell=row.insertCell(),cell.style.height="23px",null!=TR.ACR&&(ACR=1*TR.ACR,cell.textContent=ACR.toFixed(1)),cell=row.insertCell(),cell.style.height="23px",cell.textContent=TR.GOT,cell=row.insertCell(),cell.style.height="23px",cell.textContent=TR.GPT,cell=row.insertCell(),cell.style.height="23px",cell.textContent=TR.UA,cell=row.insertCell(),cell.style.height="23px",cell.className="no-print",button=document.createElement("button"),button.className="inner_button no-print",button.textContent="詳細",button.addEventListener("click",function(e){showrow(e.target.parentNode.parentNode)}),cell.appendChild(button),cell=row.insertCell(),cell.style.height="23px",cell.className="no-print",button=document.createElement("button"),button.className="inner_button no-print",button.textContent="更新",button.addEventListener("click",function(e){deleterow(e.target.parentNode.parentNode)}),cell.appendChild(button))}function copyrow(e){thedate=e.cells[0].textContent,e.cells[1].textContent?theAC=e.cells[1].textContent:theAC="-",e.cells[2].textContent?theA1C=e.cells[2].textContent:theA1C="-",e.cells[3].textContent?theTC=e.cells[3].textContent:theTC="-",e.cells[4].textContent?theTG=e.cells[4].textContent:theTG="-",e.cells[5].textContent?theHDL=e.cells[5].textContent:theHDL="-",e.cells[6].textContent?theLDL=e.cells[6].textContent:theLDL="-",e.cells[7].textContent?theCre=e.cells[7].textContent:theCre="-",e.cells[8].textContent?theGFR=e.cells[8].textContent:theGFR="-",e.cells[9].textContent?thePCR=e.cells[9].textContent:thePCR="-",e.cells[10].textContent?theACR=e.cells[10].textContent:theACR="-",e.cells[11].textContent?theGOT=e.cells[11].textContent:theGOT="-",e.cells[12].textContent?theGPT=e.cells[12].textContent:theGPT="-",e.cells[13].textContent?theUA=e.cells[13].textContent:theUA="-",msg=thedate+" AC1A1C:"+theAC+"/"+theA1C+"\nTC/TG/HDL/LDL:"+theTC+"/"+theTG+"/"+theHDL+"/"+theLDL+"\nCre/eGFT/PCR/ACR:"+theCre+"/"+theGFR+"/"+thePCR+"/"+theACR+"\nGOT/GPT:"+theGOT+"/"+theGPT+"\nUA:"+theUA,navigator.clipboard.writeText(msg).then(()=>{alert(msg+"\n已複製")}).catch(e=>{console.error("出錯了:",e)})}function deleterow(e){for(thedate=e.cells[0].textContent,deletedata=insertdata[thedate].rowdata,deletearray=[],i=0;i<deletedata.length;i++)templine="userID="+deletedata[i].userID+"&RELKEY1="+deletedata[i].RELKEY1,deletearray.push(templine);delUrl=theapiurl+"?mode=delete&postkeys="+btoa(JSON.stringify(deletearray)),xmlHttp=new XMLHttpRequest,xmlHttp.open("GET",delUrl,!1),xmlHttp.send(),delres=xmlHttp.responseText,"suscess"==delres&&searchdata()}function showrow(e){var t=window.open("","_blank");if(t){for(thedate=e.cells[0].textContent,showdata=insertdata[thedate].rowdata,SCYdate=showdata[0].OP_DATE1.split("T")[0],SMKYY=SCYdate.split("-")[0]-1911,SMKY=SMKYY+SCYdate.split("-")[1]+SCYdate.split("-")[2],t.document.write("<!DOCTYPE html>\n"),t.document.write("<html>\n"),t.document.write("<head>\n"),t.document.write("<title>"+SMKY+"檢驗報告("+showdata[0].NAME+")</title>\n"),t.document.write("<style>\n"),t.document.write(".theerror {font-size: 40px; font-family: '微軟正黑體', sans-serif; line-height: 1.2;}\n"),t.document.write(".thesitename {width: 1100px; text-align: center; font-size: 40px; font-family: '微軟正黑體', sans-serif; line-height: 1.2;}\n"),t.document.write(".basic {font-size: 24px; font-family: '微軟正黑體', sans-serif; line-height: 1.2;}\n"),t.document.write("table { border-collapse: collapse; width: 1050px; }\n"),t.document.write("th, td { border: 2px solid #020202; text-align: center; padding: 8px; font-size: 20px; font-family: '微軟正黑體'; }\n"),t.document.write("th { background-color: #f2f2f2; }\n"),t.document.write("</style>\n"),t.document.write("</head>\n"),t.document.write("<body>\n"),t.document.write("<div class='thesitename'>"+showdata[0].HOS_NAME+"檢驗報告("+SMKY+")</div>\n"),t.document.write("<div class='basic'>姓名:"+showdata[0].NAME+"</div>\n"),t.document.write("<div class='basic'>證號:"+showdata[0].ID+"</div>\n"),scyb=showdata[0].BIRTH.split("T")[0],smkyyb=scyb.split("-")[0]-1911,smkyb=smkyyb+scyb.split("-")[1]+scyb.split("-")[2],t.document.write("<div class='basic'>生日:"+smkyb+"</div>\n"),t.document.write("<table class='thetable'>\n"),t.document.write("<tbody\n"),t.document.write("<tr><td>中文名稱</td><td>英文名稱</td><td>檢驗結果</td><td>單位</td><td>參考值</td></tr>"),i=0;i<showdata.length;i++)for(trr=showdata[i],j=0;j<trr.modelOP013M1s.length;j++)trr.modelOP013M1s[j].desc2?C1=trr.modelOP013M1s[j].desc2:C1="",trr.modelOP013M1s[j].desc1?C2=trr.modelOP013M1s[j].desc1:C2="",trr.modelOP013M1s[j].S_INPUT1?C30=trr.modelOP013M1s[j].S_INPUT1:C30="",trr.modelOP013M1s[j].SAY_INPUT1?C31=trr.modelOP013M1s[j].SAY_INPUT1:C31="",trr.modelOP013M1s[j].UNIT1?C4=trr.modelOP013M1s[j].UNIT1:C4="",trr.modelOP013M1s[j].desc0?C5=trr.modelOP013M1s[j].desc0:C5="",C3=C30+" "+C31,t.document.write("<tr><td>"+C1+"</td><td>"+C2+"</td><td>"+C3+"</td><td>"+C4+"</td><td>"+C5+"</td></tr>");t.document.write("</tbody>\n"),t.document.write("</table>\n"),t.document.write("</body>\n"),t.document.write("</html>\n"),t.document.close()}else alert("無法彈跳視窗")}function sortdate(){table=document.getElementsByClassName("thetable")[0],currentsort=table.rows[0].cells[0],currentsort.textContent.includes("▼")?(table.innerHTML="",titilelist=["日期▲","AC","A1C","TC","TG","HDL","LDL","Cre","eGFR","UPCR","UACR","GOT","GPT","UA",""],inserttitle(table,titilelist),thedates=Object.keys(insertdata),thedates.sort(function(e,t){return e.localeCompare(t)}),insert(table,thedates)):(table.innerHTML="",titilelist=["日期▼","AC","A1C","TC","TG","HDL","LDL","Cre","eGFR","UPCR","UACR","GOT","GPT","UA",""],inserttitle(table,titilelist),thedates=Object.keys(insertdata),thedates.sort(function(e,t){return t.localeCompare(e)}),insert(table,thedates))}function drowlinechart(e,t,l,n){labels=Object.keys(t),data=Object.values(t).map(e=>parseFloat(e)),ctx=document.getElementById("myLineChart").getContext("2d"),t.forEach(function(e){e.x=moment(e.x).format("YYYY-MM-DD")});try{myLineChart&&myLineChart.destroy()}catch(e){}finally{myLineChart=new Chart(ctx,{type:"line",data:{datasets:[{label:e,borderColor:"rgb(75, 192, 192)",data:t,borderWidth:4,pointRadius:8,pointHoverRadius:12,fill:!1}]},options:{scales:{x:{type:"time",time:{unit:"month",displayFormats:{month:"YYYY-MM"},tooltipFormat:"YYYY-MM-DD"},title:{display:!0}},y:{title:{display:!0}}},plugins:{annotation:{annotations:{line1:{type:"line",mode:"horizontal",scaleID:"y",value:l,borderColor:"red",borderWidth:2,borderDash:[5,5],label:{content:"目標值",enabled:!0,position:"right"}},line2:{type:"line",mode:"horizontal",scaleID:"y",value:n,borderColor:"red",borderWidth:2,borderDash:[5,5],label:{content:"目標值",enabled:!0,position:"right"}}}}}}})}}currentsort="D",window.onload=function(){var e=window.location.search,t=new URLSearchParams(e),l=t.get("thesite"),n=t.get("theID");""!=l&&null!=l&&(document.getElementById("thesite").value=l.toUpperCase()),""!=n&&null!=n&&(document.getElementById("theid").value=n.toUpperCase()),""!=l&&null!=l&&""!=n&&null!=n&&searchdata()};</script>
</body>
</html>
